<?php

namespace Eugef\Funda\FundaBundle\Tests\Utils;

use Eugef\Funda\FundaBundle\Utils\FundaConnector;

class ReportControllerTest extends \PHPUnit_Framework_TestCase
{
    /**
     * Test how agencies data is collected from Funda Json response
     */   
    public function testGetAgenciesData()
    {
        $report = array(
            'pages' => 10,
            'params' => array(
                'type' => 'koop',
                'zo' => '/amsterdam/tuin/',
            )
        );
        
        $apiCaller = $this->getMockBuilder('Lsw\ApiCallerBundle\Caller\LoggingApiCaller')
                        ->disableOriginalConstructor()
                        ->getMock();        
        
        // Mock method that does cURL request
        $apiCaller->expects($this->any())
                ->method('call')
                ->will($this->returnValue(
                        json_decode(
                            '{"Metadata":{"ObjectType":"Koopwoningen","Omschrijving":"Koopwoningen > Amsterdam | Tuin","Titel":"Huizen te koop in Amsterdam"},"Objects":[{"AangebodenSindsTekst":"<span title=\"langer dan 6 maanden\">6+ maanden<\/span>","AanmeldDatum":"\/Date(1262300400000+0100)\/","AantalKamers":6,"AantalKavels":null,"Adres":"Hendrik Bulthuisstraat 16","Afstand":0,"BronCode":"NVM","ChildrenObjects":[],"DatumOndertekeningAkte":null,"Foto":"http:\/\/cloud.funda.nl\/valentina_media\/042\/729\/391_klein.jpg","FotoLarge":"http:\/\/cloud.funda.nl\/valentina_media\/042\/729\/391_groot.jpg","FotoLargest":"http:\/\/cloud.funda.nl\/valentina_media\/042\/729\/391_grotere.jpg","FotoMedium":"http:\/\/cloud.funda.nl\/valentina_media\/042\/729\/391_middel.jpg","FotoSecure":"http:\/\/cloud.funda.nl\/valentina_media\/042\/729\/391_klein.jpg","GewijzigdDatum":null,"GlobalId":2433344,"GroupByObjectType":"400b18e1-d7ef-4b95-85b1-83563b41b48c","Heeft360GradenFoto":false,"HeeftBrochure":true,"HeeftOverbruggingsgrarantie":false,"HeeftPlattegrond":false,"HeeftTophuis":true,"HeeftVeiling":false,"HeeftVideo":false,"HuurPrijsTot":null,"Huurprijs":null,"HuurprijsFormaat":null,"Id":"400b18e1-d7ef-4b95-85b1-83563b41b48c","InUnitsVanaf":null,"IndProjectObjectType":false,"IndTransactieMakelaarTonen":"true","IsSearchable":true,"IsVerhuurd":false,"IsVerkocht":false,"IsVerkochtOfVerhuurd":false,"Koopprijs":365000,"KoopprijsFormaat":"<[KoopPrijs]> <{kosten koper|kort}>","KoopprijsTot":365000,"MakelaarId":12285,"MakelaarNaam":"Makelaarsland","MobileURL":"http:\/\/m.funda.nl\/obj.aspx?goi=2433344","OpenHuis":["\/Date(1396688400000+0200)\/"],"Oppervlakte":0,"Perceeloppervlakte":125,"Postcode":"1067SC","Prijs":{"HuurAbbreviation":"","Huurprijs":null,"HuurprijsOpAanvraag":"","HuurprijsTot":null,"KoopAbbreviation":"k.k.","Koopprijs":365000,"KoopprijsOpAanvraag":"","KoopprijsTot":365000,"OriginelePrijs":387000,"VeilingText":""},"PrijsGeformatteerdHtml":"<span class=\"price-wrapper\"><span class=\"price\">&euro;&nbsp;365.000<\/span> <abbr class=\"price-ext\">k.k.<\/abbr><br\/><del class=\"price-del\"><span class=\"price\">&euro;&nbsp;387.000<\/span> <abbr class=\"price-ext\">k.k.<\/abbr><\/del><\/span>","PrijsGeformatteerdTextHuur":"<span class=\"price-wrapper\"><span class=\"price\">&euro;&nbsp;365.000<\/span> <abbr class=\"price-ext\">k.k.<\/abbr><br\/><del class=\"price-del\"><span class=\"price\">&euro;&nbsp;387.000<\/span> <abbr class=\"price-ext\">k.k.<\/abbr><\/del><\/span>","PrijsGeformatteerdTextKoop":"<span class=\"price-wrapper\"><span class=\"price\">&euro;&nbsp;365.000<\/span> <abbr class=\"price-ext\">k.k.<\/abbr><br\/><del class=\"price-del\"><span class=\"price\">&euro;&nbsp;387.000<\/span> <abbr class=\"price-ext\">k.k.<\/abbr><\/del><\/span>","Producten":["Top","Brochure"],"ProjectNaam":null,"PromoLabel":{"HasPromotionLabel":false,"PromotionPhotos":[],"PromotionPhotosSecure":null,"PromotionType":0,"RibbonColor":0,"RibbonText":null,"Tagline":null},"PublicatieDatum":"\/Date(1377644711000+0200)\/","Soort-aanbod":"woonhuis","SoortAanbod":10,"StartOplevering":null,"TransactieAfmeldDatum":null,"TransactieMakelaarId":null,"TransactieMakelaarNaam":null,"TypeProject":0,"URL":"http:\/\/www.funda.nl\/koop\/amsterdam\/huis-48888707-hendrik-bulthuisstraat-16\/","VerkoopStatus":"StatusBeschikbaar","WGS84_X":4.795719,"WGS84_Y":52.37387,"WoonOppervlakteTot":152,"Woonoppervlakte":152,"Woonplaats":"Amsterdam","ZoekType":[10]},{"AangebodenSindsTekst":"28 maart 2014","AanmeldDatum":"\/Date(1262300400000+0100)\/","AantalKamers":4,"AantalKavels":null,"Adres":"Blauwvoetstraat 55","Afstand":0,"BronCode":"NVM","ChildrenObjects":[],"DatumOndertekeningAkte":null,"Foto":"http:\/\/cloud.funda.nl\/valentina_media\/043\/230\/402_klein.jpg","FotoLarge":"http:\/\/cloud.funda.nl\/valentina_media\/043\/230\/402_groot.jpg","FotoLargest":"http:\/\/cloud.funda.nl\/valentina_media\/043\/230\/402_grotere.jpg","FotoMedium":"http:\/\/cloud.funda.nl\/valentina_media\/043\/230\/402_middel.jpg","FotoSecure":"http:\/\/cloud.funda.nl\/valentina_media\/043\/230\/402_klein.jpg","GewijzigdDatum":null,"GlobalId":2617813,"GroupByObjectType":"1dc99599-64c8-4d6d-a59a-dd4c36bb3c36","Heeft360GradenFoto":false,"HeeftBrochure":true,"HeeftOverbruggingsgrarantie":true,"HeeftPlattegrond":true,"HeeftTophuis":true,"HeeftVeiling":false,"HeeftVideo":false,"HuurPrijsTot":null,"Huurprijs":null,"HuurprijsFormaat":null,"Id":"1dc99599-64c8-4d6d-a59a-dd4c36bb3c36","InUnitsVanaf":null,"IndProjectObjectType":false,"IndTransactieMakelaarTonen":"true","IsSearchable":true,"IsVerhuurd":false,"IsVerkocht":false,"IsVerkochtOfVerhuurd":false,"Koopprijs":240000,"KoopprijsFormaat":"<[KoopPrijs]> <{kosten koper|kort}>","KoopprijsTot":240000,"MakelaarId":24079,"MakelaarNaam":"Van der Linden","MobileURL":"http:\/\/m.funda.nl\/obj.aspx?goi=2617813","OpenHuis":["\/Date(1396688400000+0200)\/"],"Oppervlakte":0,"Perceeloppervlakte":null,"Postcode":"1061BM","Prijs":{"HuurAbbreviation":"","Huurprijs":null,"HuurprijsOpAanvraag":"","HuurprijsTot":null,"KoopAbbreviation":"k.k.","Koopprijs":240000,"KoopprijsOpAanvraag":"","KoopprijsTot":240000,"OriginelePrijs":null,"VeilingText":""},"PrijsGeformatteerdHtml":"<span class=\"price-wrapper\"><span class=\"price\">&euro;&nbsp;240.000<\/span> <abbr class=\"price-ext\">k.k.<\/abbr><\/span>","PrijsGeformatteerdTextHuur":"<span class=\"price-wrapper\"><span class=\"price\">&euro;&nbsp;240.000<\/span> <abbr class=\"price-ext\">k.k.<\/abbr><\/span>","PrijsGeformatteerdTextKoop":"<span class=\"price-wrapper\"><span class=\"price\">&euro;&nbsp;240.000<\/span> <abbr class=\"price-ext\">k.k.<\/abbr><\/span>","Producten":["Top","Overbruggingsgarantie","Plattegrond","Brochure","Featured"],"ProjectNaam":null,"PromoLabel":{"HasPromotionLabel":true,"PromotionPhotos":[],"PromotionPhotosSecure":null,"PromotionType":2,"RibbonColor":1,"RibbonText":"NIEUW","Tagline":"Nieuw appartementencomplex, met buitenruimte en parkeerplaats."},"PublicatieDatum":"\/Date(1395965111000+0100)\/","Soort-aanbod":"appartement","SoortAanbod":10,"StartOplevering":null,"TransactieAfmeldDatum":null,"TransactieMakelaarId":null,"TransactieMakelaarNaam":null,"TypeProject":0,"URL":"http:\/\/www.funda.nl\/koop\/amsterdam\/appartement-48062276-blauwvoetstraat-55\/","VerkoopStatus":"StatusBeschikbaar","WGS84_X":4.838819,"WGS84_Y":52.37642,"WoonOppervlakteTot":120,"Woonoppervlakte":120,"Woonplaats":"Amsterdam","ZoekType":[10]},{"AangebodenSindsTekst":"2 maanden","AanmeldDatum":"\/Date(1262300400000+0100)\/","AantalKamers":3,"AantalKavels":null,"Adres":"Rietlandterras 16 Hs+PP","Afstand":0,"BronCode":"NVM","ChildrenObjects":[],"DatumOndertekeningAkte":null,"Foto":"http:\/\/cloud.funda.nl\/valentina_media\/041\/684\/605_klein.jpg","FotoLarge":"http:\/\/cloud.funda.nl\/valentina_media\/041\/684\/605_groot.jpg","FotoLargest":"http:\/\/cloud.funda.nl\/valentina_media\/041\/684\/605_grotere.jpg","FotoMedium":"http:\/\/cloud.funda.nl\/valentina_media\/041\/684\/605_middel.jpg","FotoSecure":"http:\/\/cloud.funda.nl\/valentina_media\/041\/684\/605_klein.jpg","GewijzigdDatum":null,"GlobalId":2556344,"GroupByObjectType":"e35e2cd5-e185-4a30-85f6-661c643e5351","Heeft360GradenFoto":false,"HeeftBrochure":false,"HeeftOverbruggingsgrarantie":false,"HeeftPlattegrond":false,"HeeftTophuis":true,"HeeftVeiling":false,"HeeftVideo":false,"HuurPrijsTot":null,"Huurprijs":null,"HuurprijsFormaat":null,"Id":"e35e2cd5-e185-4a30-85f6-661c643e5351","InUnitsVanaf":null,"IndProjectObjectType":false,"IndTransactieMakelaarTonen":"true","IsSearchable":true,"IsVerhuurd":false,"IsVerkocht":false,"IsVerkochtOfVerhuurd":false,"Koopprijs":349000,"KoopprijsFormaat":"<[KoopPrijs]> <{kosten koper|kort}>","KoopprijsTot":349000,"MakelaarId":24705,"MakelaarNaam":"Eefje Voogd Makelaardij","MobileURL":"http:\/\/m.funda.nl\/obj.aspx?goi=2556344","OpenHuis":["\/Date(1396688400000+0200)\/"],"Oppervlakte":0,"Perceeloppervlakte":null,"Postcode":"1019EW","Prijs":{"HuurAbbreviation":"","Huurprijs":null,"HuurprijsOpAanvraag":"","HuurprijsTot":null,"KoopAbbreviation":"k.k.","Koopprijs":349000,"KoopprijsOpAanvraag":"","KoopprijsTot":349000,"OriginelePrijs":null,"VeilingText":""},"PrijsGeformatteerdHtml":"<span class=\"price-wrapper\"><span class=\"price\">&euro;&nbsp;349.000<\/span> <abbr class=\"price-ext\">k.k.<\/abbr><\/span>","PrijsGeformatteerdTextHuur":"<span class=\"price-wrapper\"><span class=\"price\">&euro;&nbsp;349.000<\/span> <abbr class=\"price-ext\">k.k.<\/abbr><\/span>","PrijsGeformatteerdTextKoop":"<span class=\"price-wrapper\"><span class=\"price\">&euro;&nbsp;349.000<\/span> <abbr class=\"price-ext\">k.k.<\/abbr><\/span>","Producten":["Top"],"ProjectNaam":null,"PromoLabel":{"HasPromotionLabel":false,"PromotionPhotos":[],"PromotionPhotosSecure":null,"PromotionType":0,"RibbonColor":0,"RibbonText":null,"Tagline":null},"PublicatieDatum":"\/Date(1390518000000+0100)\/","Soort-aanbod":"appartement","SoortAanbod":10,"StartOplevering":null,"TransactieAfmeldDatum":null,"TransactieMakelaarId":null,"TransactieMakelaarNaam":null,"TypeProject":0,"URL":"http:\/\/www.funda.nl\/koop\/amsterdam\/appartement-48901707-rietlandterras-16-hs-pp\/","VerkoopStatus":"StatusBeschikbaar","WGS84_X":4.935488,"WGS84_Y":52.37174,"WoonOppervlakteTot":100,"Woonoppervlakte":100,"Woonplaats":"Amsterdam","ZoekType":[10]},{"AangebodenSindsTekst":"28 maart 2014","AanmeldDatum":"\/Date(1262300400000+0100)\/","AantalKamers":4,"AantalKavels":null,"Adres":"Wijttenbachstraat 54 hs","Afstand":0,"BronCode":"NVM","ChildrenObjects":[],"DatumOndertekeningAkte":null,"Foto":"http:\/\/cloud.funda.nl\/valentina_media\/043\/234\/879_klein.jpg","FotoLarge":"http:\/\/cloud.funda.nl\/valentina_media\/043\/234\/879_groot.jpg","FotoLargest":"http:\/\/cloud.funda.nl\/valentina_media\/043\/234\/879_grotere.jpg","FotoMedium":"http:\/\/cloud.funda.nl\/valentina_media\/043\/234\/879_middel.jpg","FotoSecure":"http:\/\/cloud.funda.nl\/valentina_media\/043\/234\/879_klein.jpg","GewijzigdDatum":null,"GlobalId":2617948,"GroupByObjectType":"5a893801-0c2b-42c2-963b-a4311fe061de","Heeft360GradenFoto":false,"HeeftBrochure":true,"HeeftOverbruggingsgrarantie":false,"HeeftPlattegrond":false,"HeeftTophuis":true,"HeeftVeiling":false,"HeeftVideo":false,"HuurPrijsTot":null,"Huurprijs":null,"HuurprijsFormaat":null,"Id":"5a893801-0c2b-42c2-963b-a4311fe061de","InUnitsVanaf":null,"IndProjectObjectType":false,"IndTransactieMakelaarTonen":"true","IsSearchable":true,"IsVerhuurd":false,"IsVerkocht":false,"IsVerkochtOfVerhuurd":false,"Koopprijs":625000,"KoopprijsFormaat":"<[KoopPrijs]> <{kosten koper|kort}>","KoopprijsTot":625000,"MakelaarId":12285,"MakelaarNaam":"Makelaarsland","MobileURL":"http:\/\/m.funda.nl\/obj.aspx?goi=2617948","OpenHuis":["\/Date(1396688400000+0200)\/"],"Oppervlakte":0,"Perceeloppervlakte":null,"Postcode":"1093JE","Prijs":{"HuurAbbreviation":"","Huurprijs":null,"HuurprijsOpAanvraag":"","HuurprijsTot":null,"KoopAbbreviation":"k.k.","Koopprijs":625000,"KoopprijsOpAanvraag":"","KoopprijsTot":625000,"OriginelePrijs":null,"VeilingText":""},"PrijsGeformatteerdHtml":"<span class=\"price-wrapper\"><span class=\"price\">&euro;&nbsp;625.000<\/span> <abbr class=\"price-ext\">k.k.<\/abbr><\/span>","PrijsGeformatteerdTextHuur":"<span class=\"price-wrapper\"><span class=\"price\">&euro;&nbsp;625.000<\/span> <abbr class=\"price-ext\">k.k.<\/abbr><\/span>","PrijsGeformatteerdTextKoop":"<span class=\"price-wrapper\"><span class=\"price\">&euro;&nbsp;625.000<\/span> <abbr class=\"price-ext\">k.k.<\/abbr><\/span>","Producten":["Top","Brochure"],"ProjectNaam":null,"PromoLabel":{"HasPromotionLabel":false,"PromotionPhotos":[],"PromotionPhotosSecure":null,"PromotionType":0,"RibbonColor":0,"RibbonText":null,"Tagline":null},"PublicatieDatum":"\/Date(1395965111000+0100)\/","Soort-aanbod":"appartement","SoortAanbod":10,"StartOplevering":null,"TransactieAfmeldDatum":null,"TransactieMakelaarId":null,"TransactieMakelaarNaam":null,"TypeProject":0,"URL":"http:\/\/www.funda.nl\/koop\/amsterdam\/appartement-48062301-wijttenbachstraat-54-hs\/","VerkoopStatus":"StatusBeschikbaar","WGS84_X":4.92771,"WGS84_Y":52.3605,"WoonOppervlakteTot":136,"Woonoppervlakte":136,"Woonplaats":"Amsterdam","ZoekType":[10]},{"AangebodenSindsTekst":"7 weken","AanmeldDatum":"\/Date(1262300400000+0100)\/","AantalKamers":4,"AantalKavels":null,"Adres":"Antwerpenbaan 66","Afstand":0,"BronCode":"NVM","ChildrenObjects":[],"DatumOndertekeningAkte":null,"Foto":"http:\/\/cloud.funda.nl\/valentina_media\/042\/143\/311_klein.jpg","FotoLarge":"http:\/\/cloud.funda.nl\/valentina_media\/042\/143\/311_groot.jpg","FotoLargest":"http:\/\/cloud.funda.nl\/valentina_media\/042\/143\/311_grotere.jpg","FotoMedium":"http:\/\/cloud.funda.nl\/valentina_media\/042\/143\/311_middel.jpg","FotoSecure":"http:\/\/cloud.funda.nl\/valentina_media\/042\/143\/311_klein.jpg","GewijzigdDatum":null,"GlobalId":2574113,"GroupByObjectType":"25bab054-2b7a-4897-9378-c0655875f6d1","Heeft360GradenFoto":true,"HeeftBrochure":false,"HeeftOverbruggingsgrarantie":false,"HeeftPlattegrond":true,"HeeftTophuis":true,"HeeftVeiling":false,"HeeftVideo":false,"HuurPrijsTot":null,"Huurprijs":null,"HuurprijsFormaat":null,"Id":"25bab054-2b7a-4897-9378-c0655875f6d1","InUnitsVanaf":null,"IndProjectObjectType":false,"IndTransactieMakelaarTonen":"true","IsSearchable":true,"IsVerhuurd":false,"IsVerkocht":false,"IsVerkochtOfVerhuurd":false,"Koopprijs":250000,"KoopprijsFormaat":"<[KoopPrijs]> <{kosten koper|kort}>","KoopprijsTot":250000,"MakelaarId":24512,"MakelaarNaam":"Moerland makelaardij o.g. b.v.","MobileURL":"http:\/\/m.funda.nl\/obj.aspx?goi=2574113","OpenHuis":["\/Date(1396692000000+0200)\/"],"Oppervlakte":0,"Perceeloppervlakte":113,"Postcode":"1066SJ","Prijs":{"HuurAbbreviation":"","Huurprijs":null,"HuurprijsOpAanvraag":"","HuurprijsTot":null,"KoopAbbreviation":"k.k.","Koopprijs":250000,"KoopprijsOpAanvraag":"","KoopprijsTot":250000,"OriginelePrijs":null,"VeilingText":""},"PrijsGeformatteerdHtml":"<span class=\"price-wrapper\"><span class=\"price\">&euro;&nbsp;250.000<\/span> <abbr class=\"price-ext\">k.k.<\/abbr><\/span>","PrijsGeformatteerdTextHuur":"<span class=\"price-wrapper\"><span class=\"price\">&euro;&nbsp;250.000<\/span> <abbr class=\"price-ext\">k.k.<\/abbr><\/span>","PrijsGeformatteerdTextKoop":"<span class=\"price-wrapper\"><span class=\"price\">&euro;&nbsp;250.000<\/span> <abbr class=\"price-ext\">k.k.<\/abbr><\/span>","Producten":["Top","Plattegrond","360-fotos"],"ProjectNaam":null,"PromoLabel":{"HasPromotionLabel":false,"PromotionPhotos":[],"PromotionPhotosSecure":null,"PromotionType":0,"RibbonColor":0,"RibbonText":null,"Tagline":null},"PublicatieDatum":"\/Date(1392077118000+0100)\/","Soort-aanbod":"woonhuis","SoortAanbod":10,"StartOplevering":null,"TransactieAfmeldDatum":null,"TransactieMakelaarId":null,"TransactieMakelaarNaam":null,"TypeProject":0,"URL":"http:\/\/www.funda.nl\/koop\/amsterdam\/huis-48929576-antwerpenbaan-66\/","VerkoopStatus":"StatusBeschikbaar","WGS84_X":4.801842,"WGS84_Y":52.34495,"WoonOppervlakteTot":103,"Woonoppervlakte":103,"Woonplaats":"Amsterdam","ZoekType":[10]}],"Paging":{"AantalPaginas":281,"HuidigePagina":1,"VolgendeUrl":"\/~\/koop\/amsterdam\/tuin\/p2\/","VorigeUrl":null},"TotaalAantalObjecten":1403}'
                        )
                    ));
        
        $funda = new FundaConnector('apikey', $apiCaller);
        
        $this->assertEquals(
            $funda->getAgenciesData($report['params'], $report['pages']), 
            array (
                12285 => array(
                    'name' => 'Makelaarsland',
                    'count' => 2 * $report['pages'],
                ),
                24079 => array(
                    'name' => 'Van der Linden',
                    'count' => 1 * $report['pages'],
                ),
                24705 => array(
                    'name' => 'Eefje Voogd Makelaardij',
                    'count' => 1 * $report['pages'],
                ),
                24512 => array(
                    'name' => 'Moerland makelaardij o.g. b.v.',
                    'count' => 1 * $report['pages'],
                )
            )
        );
    }
        
}
